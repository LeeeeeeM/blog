## Vue框架在快应用的最佳实践

小程序市场经过2018年的沉淀出现了多足鼎立的局面，包括微信、支付宝、今日头条等多个APP巨头都先后杀入了小程序市场。其中，最独树一帜的当属小米出品的快应用。

快应用不依赖于APP，无需下载即点即用。同时为了保证性能，抛弃了webview渲染而使用原生渲染引擎。

快应用的架构共分为如下几层：

![架构]("./1.png")

1、platform层。在这一层直接调用j2v8底层的方法与系统底层通信，并对快应用上层提供接口。

2、runtime层（包含css样式计算）。这一层用于定义DOM规范、赋予DOM相应的属性和方法，适配多框架、归一化各个运行时框架的DOM指令并定义渲染引擎的指令发送策略。

3、dock层。在这一层抽象出一个快应用实例容器，在容器内提供快应用对外暴露的API，通过订阅发布模式跟dsl层的运行时框架进行通信。

4、dsl层。在这一层提供快应用的运行时框架。运行时框架包括编译jsDOM树、数据驱动等能力。

通过rollup打包，最终会将前三层打包成infras.js。infras.js在执行时做了以下几件事：1、初始化系统平台，对global的原生对象和方法进行劫持与重构。2、初始化runtime能力，对外暴露helper对象。3、在global上注册全局方法，提供对外API并在合适的时机通过安卓定位dsl文件，注册安装dsl。

在快应用的初始版本中，我们在dsl层提供了一套运行时框架Xvm.js，这套框架已经提供了满足开发者基本开发需求的语法和API能力。但是由于Vue框架在前端开发的高效和火爆，我们团队决定引入Vue框架。我们曾考虑过通过在编译时将Vue的语法编译成可以在Xvm上运行的jsDOM树，但是Xvm的语法并不能和Vue一一对其，且维护成本较高，所以我们放弃了单纯修改编译时的方案。选择了在DOM实现上尽量贴合web规范，修改Vue的runtime方案。

由于前三层是共用架构，我们着手从dsl层开始改造。dsl文件目录如下

![dsl文件目录]("./2.png")

由于dsl层是与dock层通过sub/pub模式进行通信的。
dsl层需要抽象出一个桥接层适配，桥接层里面暴露一个init方法对dock层暴露出来的快应用容器进行监听等初始化操作。监听内容包含快应用App初始化、Page初始化与销毁，Page级别的生命周期、事件触发以及回调。dsl层的代码负责监听回调的具体实现，以此达到与dock层解耦合的目的。

![interface.js]("./3.png")

createApplication和createPage是快应用的重要阶段，以这个阶段为例来学习快应用是如何进行解耦的。

infras.js执行之后，快应用安卓端会在合适的时机加载正确的dsl层代码。完成上述的初始化之后，安卓端触发createApp操作，dsl层接收到createApplication操作之后，触发监听函数，执行App的初始化操作，包括挂载属性和触发`applc:onCreate`生命周期等。

![createApp.js]("./4.png")

之后安卓端触发createPage操作，dsl层接收到createPage操作之后，执行Page的初始化操作。在Page的初始化的过程中，需要给Page绑定一个vm。

![createPage.js]("./5.png")

在这里我们使用了工厂模式传入page对应的document和dock层暴露的接口，这样使每一个Page产出一个绑定Page的Vue类。在该Page的每个组件都按照其Vue类进行组件的实例化。在每个Page的根组件里，混入了Page级别的API并绑定生命周期，达到Vue与Page的完美结合。

![Vue工厂函数]("./6.png")

